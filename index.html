<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>ç›£ä¿®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ãƒ„ãƒ¼ãƒ« (Firebaseé€£æº)</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .controls { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
    .controls h3 { margin-top: 0; }
    .btn-group { margin: 10px 0; }
    .btn { padding: 8px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #545b62; }
    .btn-success { background: #28a745; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
    
    /* Firebaseæ¥ç¶šçŠ¶æ³ */
    .connection-status { 
      padding: 10px; margin: 10px 0; border-radius: 5px; 
      display: flex; align-items: center; gap: 10px;
    }
    .status-connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status-indicator { width: 12px; height: 12px; border-radius: 50%; }
    .indicator-connected { background: #28a745; }
    .indicator-disconnected { background: #dc3545; }
    
    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† */
    .user-management { margin: 10px 0; }
    .current-user { font-weight: bold; color: #007bff; }
    .online-users { margin-top: 10px; }
    .user-badge { 
      display: inline-block; padding: 2px 8px; margin: 2px; 
      background: #e9ecef; border-radius: 12px; font-size: 12px; 
    }
    .user-badge.current { background: #007bff; color: white; }
    
    /* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç·¨é›†ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .editing-indicator {
      position: absolute; top: -5px; right: -5px; 
      background: #ffc107; color: #212529; padding: 2px 6px; 
      border-radius: 10px; font-size: 10px; z-index: 10;
    }
    
    /* è¡¨ã®ã‚ºãƒ¼ãƒ æ©Ÿèƒ½ */
    .zoom-controls { margin: 10px 0; display: flex; align-items: center; gap: 10px; }
    .zoom-slider { width: 200px; }
    .zoom-display { font-weight: bold; min-width: 50px; }
    
    /* è¡¨ã®ã‚³ãƒ³ãƒ†ãƒŠ - æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
    .table-container { 
      overflow: auto; 
      border: 1px solid #ddd; 
      max-height: 80vh;
      position: relative;
    }
    
    /* è¡¨ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    table { 
      border-collapse: collapse; 
      table-layout: fixed;
      transform-origin: top left;
    }
    
    /* ã‚»ãƒ«ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    th, td { 
      border: 1px solid #ddd; 
      padding: 10px; 
      text-align: center; 
      vertical-align: top; 
      position: relative;
      overflow: hidden;
    }
    
    /* ã‚«ãƒ†ã‚´ãƒªåˆ—ã®å›ºå®šå¹… */
    .category-column { 
      width: 200px; 
      min-width: 200px; 
      max-width: 200px; 
    }
    
    /* é€±åˆ—ã®åˆæœŸå¹… */
    .week-column { 
      width: 180px; 
      min-width: 120px; 
      max-width: 300px; 
    }
    
    /* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */
    .resize-handle {
      position: absolute;
      top: 0;
      right: 0;
      width: 5px;
      height: 100%;
      background: transparent;
      cursor: col-resize;
      z-index: 10;
    }
    
    .resize-handle:hover {
      background: #007bff;
      opacity: 0.3;
    }
    
    /* ãƒªã‚µã‚¤ã‚ºä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .resizing {
      user-select: none;
    }
    
    .resize-line {
      position: absolute;
      top: 0;
      width: 2px;
      height: 100%;
      background: #007bff;
      z-index: 1000;
      pointer-events: none;
    }
    
    th { background: #f8f9fa; font-weight: bold; }
    .week-header { display: flex; flex-direction: column; align-items: center; gap: 5px; }
    .toggle-btn { background: #28a745; color: white; border: none; border-radius: 3px; 
                  padding: 2px 6px; font-size: 10px; cursor: pointer; }
    .toggle-btn.hidden { background: #6c757d; }
    .week-column-hidden { display: none !important; }
    
    .category-cell { background: #e9ecef; font-weight: bold; }
    input, select { width: 90%; margin: 2px 0; padding: 4px; box-sizing: border-box; }
    
    /* ç·¨é›†ä¸­ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .being-edited { box-shadow: 0 0 5px #ffc107; }
    
    .img-area {
      width: 80px; height: 60px; border: 2px dashed #007bff; margin: 5px auto;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      position: relative; background: #f8f9ff; border-radius: 4px;
      transition: all 0.3s ease;
      user-select: none;
    }
    .img-area:hover { 
      border-color: #0056b3; 
      background: #e6f3ff;
      transform: scale(1.02);
    }
    .img-area:active {
      transform: scale(0.98);
    }
    .img-area img { 
      width: 100%; height: 100%; object-fit: cover; 
      border-radius: 2px;
    }
    .img-area input[type=file] { 
      display: none; 
    }
    .img-delete { 
      position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; 
      border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; 
      cursor: pointer; display: none; z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .img-delete:hover {
      background: #c82333;
      transform: scale(1.1);
    }
    .img-area.has-image .img-delete { 
      display: block; 
    }
    .img-area.has-image {
      border: 2px solid #28a745;
      background: #f8fff8;
    }
    .img-area.has-image:hover {
      border-color: #20c997;
    }
    
    .calendar-day {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
      cursor: pointer;
      position: relative;
    }
    .calendar-day:hover {
      background: #e9ecef;
    }
    .calendar-day.other-month {
      color: #ccc;
      background: #f8f9fa;
    }
    .calendar-day.week-start {
      background: #d4edda;
      border-color: #28a745;
    }
    .calendar-day.week-start:hover {
      background: #c3e6cb;
    }
    .week-select { width: 150px; margin-right: 10px; }
    
    .delete-category-btn { 
      background: #dc3545; color: white; border: none; border-radius: 3px; 
      padding: 2px 6px; font-size: 10px; cursor: pointer; margin-left: 5px; 
    }

    /* Firebaseè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe; margin: 15% auto; padding: 20px;
      border: 1px solid #888; width: 500px; border-radius: 5px;
    }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: black; }
    .form-group { margin: 15px 0; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; }
    .form-group textarea { width: 100%; height: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 3px; }
  </style>
</head>
<body>
<h1>ç›£ä¿®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ãƒ„ãƒ¼ãƒ« (Firebaseé€£æº)</h1>
<!-- Firebaseæ¥ç¶šçŠ¶æ³ -->
<div class="connection-status status-disconnected" id="connectionStatus">
<div class="status-indicator indicator-disconnected"></div>
<span>Firebaseæœªæ¥ç¶š</span>
</div>
<div class="controls">
<h3>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†</h3>
<div class="btn-group">
<input id="projectName" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›" style="padding: 8px; margin-right: 10px;" type="text"/>
<button class="btn" onclick="createNewProject()">æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</button>
</div>
<div class="btn-group">
<select id="projectSelect" style="padding: 8px; margin-right: 10px; width: 200px;">
<option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ</option>
</select>
<button class="btn btn-secondary" onclick="loadProject()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿</button>
<button class="btn btn-danger" onclick="deleteProject()">å‰Šé™¤</button>
</div>
<div style="margin-top: 10px;">
<strong>ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</strong> <span id="currentProject">ãªã—</span>
</div>
<div class="user-management">
<div>ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span class="current-user" id="currentUser">æœªè¨­å®š</span></div>
<div class="online-users">
<strong>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong>
<div id="onlineUsersList"></div>
</div>
</div>
</div>
<div class="controls">
<h3>é€±ã®ç®¡ç†ãƒ»è¡¨ç¤ºè¨­å®š</h3>
<div class="btn-group">
<button class="btn" onclick="toggleCalendar()">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é€±ã‚’è¿½åŠ </button>
<div id="calendarContainer" style="display: none; margin-top: 10px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: white;">
<div style="display: flex; align-items: center; margin-bottom: 10px;">
<button class="btn btn-secondary" onclick="previousMonth()" style="margin-right: 10px;">â—€</button>
<span id="currentMonth" style="font-weight: bold; margin: 0 10px;"></span>
<button class="btn btn-secondary" onclick="nextMonth()" style="margin-left: 10px;">â–¶</button>
</div>
<table id="calendar" style="width: 100%; border-collapse: collapse;">
<thead>
<tr>
<th style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;">æ—¥</th>
<th style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;">æœˆ</th>
<th style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;">ç«</th>
<th style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;">æ°´</th>
<th style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;">æœ¨</th>
<th style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;">é‡‘</th>
<th style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;">åœŸ</th>
</tr>
</thead>
<tbody id="calendarBody">
</tbody>
</table>
<div style="margin-top: 10px; font-size: 12px; color: #666;">
          â€» æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã®é€±ã¨ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„
        </div>
</div>
</div>
<div class="btn-group">
<select class="week-select" id="hiddenWeekSelect">
<option value="">éè¡¨ç¤ºã®é€±ã‚’é¸æŠ</option>
</select>
<button class="btn btn-secondary" onclick="showHiddenWeek()">é¸æŠã—ãŸé€±ã‚’è¡¨ç¤º</button>
<button class="btn btn-secondary" onclick="showAllWeeks()">å…¨ã¦ã®é€±ã‚’è¡¨ç¤º</button>
<button class="btn btn-danger" onclick="deleteSelectedWeek()">é€±ã‚’å‰Šé™¤</button></div>
</div>
<div class="controls">
<h3>ã‚«ãƒ†ã‚´ãƒªã®ç®¡ç†</h3>
<div class="btn-group">
<button class="btn" onclick="addCategory()">ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </button>
</div>
</div>
<div class="controls">
<h3>è¡¨ã®è¡¨ç¤ºè¨­å®š</h3>
<div class="zoom-controls">
<label for="zoomSlider">è¡¨ç¤ºå€ç‡:</label>
<input class="zoom-slider" id="zoomSlider" max="200" min="50" oninput="updateZoom(this.value)" type="range" value="100"/>
<span class="zoom-display" id="zoomDisplay">100%</span>
<button class="btn btn-secondary" onclick="resetZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>
<div style="font-size: 12px; color: #666;">
      â€» åˆ—ã®å¢ƒç•Œã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å¹…ã‚’èª¿æ•´ã§ãã¾ã™<br/>
      â€» ãƒ‡ãƒ¼ã‚¿ã¯Firebaseã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™
    </div>
</div>
<div class="table-container" id="tableContainer">
<table id="mainTable">
<thead>
<tr id="headerRow">
<th class="category-column">ã‚«ãƒ†ã‚´ãƒª</th>
</tr>
</thead>
<tbody id="tableBody">
</tbody>
</table>
</div>
<!-- Firebase SDK - è¤‡æ•°ã®CDNã‚½ãƒ¼ã‚¹ã‚’è©¦è¡Œ -->
<script>
    // Firebase SDKã®å‹•çš„èª­ã¿è¾¼ã¿
    function loadFirebaseSDK() {
      const cdnUrls = [
        'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js',
        'https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js',
        'https://unpkg.com/firebase@9.23.0/compat/firebase-app.js'
      ];
      
      let currentIndex = 0;
      
      function tryLoadFirebase() {
        if (currentIndex >= cdnUrls.length) {
          console.error('å…¨ã¦ã®Firebase CDNã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          document.getElementById('connectBtn').textContent = 'Firebaseèª­ã¿è¾¼ã¿å¤±æ•—';
          return;
        }
        
        const script = document.createElement('script');
        script.src = cdnUrls[currentIndex];
        script.onload = function() {
          console.log('Firebase Appèª­ã¿è¾¼ã¿æˆåŠŸ:', cdnUrls[currentIndex]);
          // Firestoreã‚‚èª­ã¿è¾¼ã¿
          loadFirestore();
        };
        script.onerror = function() {
          console.log('Firebaseèª­ã¿è¾¼ã¿å¤±æ•—:', cdnUrls[currentIndex]);
          currentIndex++;
          tryLoadFirebase();
        };
        document.head.appendChild(script);
      }
      
      function loadFirestore() {
        const firestoreUrls = [
          'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js',
          'https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js',
          'https://unpkg.com/firebase@9.23.0/compat/firebase-firestore.js'
        ];
        
        let firestoreIndex = 0;
        
        function tryLoadFirestore() {
          if (firestoreIndex >= firestoreUrls.length) {
            console.error('Firestoreèª­ã¿è¾¼ã¿å¤±æ•—');
            return;
          }
          
          const script = document.createElement('script');
          script.src = firestoreUrls[firestoreIndex];
          script.onload = function() {
            console.log('Firestoreèª­ã¿è¾¼ã¿æˆåŠŸ:', firestoreUrls[firestoreIndex]);
            console.log('Firebase available:', typeof firebase !== 'undefined');
            
            // æ¥ç¶šãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const connectBtn = document.getElementById('connectBtn');
            if (connectBtn) {
              connectBtn.disabled = false;
              connectBtn.textContent = 'æ¥ç¶š';
            }
            
            // è‡ªå‹•æ¥ç¶šã‚’è©¦è¡Œ
            const defaultUser = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' + Math.floor(Math.random() * 1000);
            localStorage.setItem('userName', defaultUser);
            
            setTimeout(() => {
              connectToFirebase();
            }, 1000);
          };
          script.onerror = function() {
            console.log('Firestoreèª­ã¿è¾¼ã¿å¤±æ•—:', firestoreUrls[firestoreIndex]);
            firestoreIndex++;
            tryLoadFirestore();
          };
          document.head.appendChild(script);
        }
        
        tryLoadFirestore();
      }
      
      tryLoadFirebase();
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«Firebase SDKã‚’èª­ã¿è¾¼ã¿
    document.addEventListener('DOMContentLoaded', loadFirebaseSDK);
  </script>
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let weeks = ["7/1"];
let categories = ["Webåºƒå‘ŠãƒãƒŠãƒ¼", "åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ", "ãƒ‡ã‚¶ã‚¤ãƒ³"];
let hiddenWeeks = new Set();
let currentCalendarDate = new Date();
let currentZoom = 100;

// Firebaseé–¢é€£å¤‰æ•°
let firebaseApp = null;
let firestore = null;
let currentUser = null;
let currentProjectId = null;
let isConnected = false;
let onlineUsers = {};
let editingTimeouts = {};
let presenceUpdateInterval = null;

// ãƒªã‚µã‚¤ã‚ºé–¢é€£ã®å¤‰æ•°
let isResizing = false;
let resizingColumn = null;
let startX = 0;
let startWidth = 0;
let resizeLine = null;

// åˆæœŸåŒ–
function init() {
  console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
  
  // ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿
  loadLocalSettings();
  
  const headerRow = document.getElementById('headerRow');
  weeks.forEach(week => {
    const th = document.createElement('th');
    th.dataset.week = week;
    th.className = 'week-column';
    
    th.innerHTML = `
      <div class="week-header">
        <span>${week}</span>
        <button class="toggle-btn" onclick="toggleWeekVisibility('${week}')">éè¡¨ç¤º</button>
      </div>
      <div class="resize-handle"></div>
    `;
    
    headerRow.appendChild(th);
  });
  
  // ã‚«ãƒ†ã‚´ãƒªåˆ—ã«ã‚‚ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã‚’è¿½åŠ 
  const categoryHeader = headerRow.querySelector('.category-column');
  const resizeHandle = document.createElement('div');
  resizeHandle.className = 'resize-handle';
  categoryHeader.appendChild(resizeHandle);
  
  categories.forEach(cat => addCategory(cat));
  updateHiddenWeekSelect();
  initializeResizing();
  calculateTableWidth();
  
  // ğŸ”§ åˆæœŸåŒ–å¾Œã«æ—¢å­˜ã®ç”»åƒã‚¨ãƒªã‚¢ã‚’ä¿®å¾©
  setTimeout(fixExistingImageAreas, 100);
  
  console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
  
  // FirebaseçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
  setTimeout(() => {
    console.log('Firebase SDKç¢ºèª:', typeof firebase !== 'undefined');
    if (typeof firebase !== 'undefined') {
      console.log('Firebaseåˆ©ç”¨å¯èƒ½');
      const connectBtn = document.getElementById('connectBtn');
      if (connectBtn) {
        connectBtn.disabled = false;
        connectBtn.textContent = 'æ¥ç¶š';
      }
    } else {
      console.log('Firebaseèª­ã¿è¾¼ã¿ä¸­...');
    }
  }, 2000);
}

function testFileDialog() {
  debugLog('ğŸ“ === ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
  
  // ç’°å¢ƒæƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
  debugLog('ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±: ' + navigator.userAgent.substring(0, 50) + '...');
  debugLog('ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ' + window.location.protocol);
  debugLog('ãƒ›ã‚¹ãƒˆ: ' + window.location.host);
  debugLog('iframeå†…ã‹: ' + (window.self !== window.top));
  
  // ã‚·ãƒ³ãƒ—ãƒ«ãªinputè¦ç´ ã‚’ä½œæˆã—ã¦ãƒ†ã‚¹ãƒˆ
  const testInput = document.createElement('input');
  testInput.type = 'file';
  testInput.accept = 'image/*';
  testInput.style.position = 'fixed';
  testInput.style.top = '-1000px';
  document.body.appendChild(testInput);
  
  testInput.onchange = function() {
    debugLog('ğŸ‰ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆæˆåŠŸï¼');
    debugLog('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ' + (testInput.files.length ? testInput.files[0].name : 'ãªã—'));
    document.body.removeChild(testInput);
  };
  
  debugLog('ãƒ†ã‚¹ãƒˆç”¨inputè¦ç´ ã‚’ä½œæˆã—ã¾ã—ãŸ');
  
  try {
    debugLog('input.click() å®Ÿè¡Œ...');
    testInput.click();
    debugLog('input.click() å®Œäº† - ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ã‘ã°ãƒ†ã‚¹ãƒˆæˆåŠŸ');
    
    // 5ç§’å¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    setTimeout(() => {
      if (document.body.contains(testInput)) {
        debugLog('ãƒ†ã‚¹ãƒˆç”¨inputè¦ç´ ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—');
        document.body.removeChild(testInput);
      }
    }, 5000);
    
  } catch (error) {
    debugLog('âŒ input.click() ã‚¨ãƒ©ãƒ¼: ' + error.message);
    document.body.removeChild(testInput);
  }
  
  // ç”»åƒã‚¨ãƒªã‚¢ã®è©³ç´°è¨ºæ–­ã‚‚å®Ÿè¡Œ
  setTimeout(() => {
    debugLog('\n--- ç”»åƒã‚¨ãƒªã‚¢è©³ç´°è¨ºæ–­ ---');
    const imageAreas = document.querySelectorAll('.img-area');
    debugLog('ç”»åƒã‚¨ãƒªã‚¢æ•°: ' + imageAreas.length);
    
    imageAreas.forEach((area, index) => {
      debugLog(`ç”»åƒã‚¨ãƒªã‚¢ ${index + 1}:`);
      debugLog('  onclickè¨­å®š: ' + (area.onclick ? 'ã‚ã‚Š' : 'ãªã—'));
      debugLog('  è¦ç´ ã®è¡¨ç¤º: ' + window.getComputedStyle(area).display);
      debugLog('  è¦ç´ ã®ä½ç½®: ' + area.getBoundingClientRect().top + 'px');
      
      // å¼·åˆ¶çš„ã«æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      const input = area.querySelector('input[type="file"]');
      if (input) {
        debugLog('  inputè¦ç´ ç™ºè¦‹ - å¼·åˆ¶ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š');
        area.onclick = function(e) {
          debugLog('ğŸ–±ï¸ å¼·åˆ¶è¨­å®šã‚¤ãƒ™ãƒ³ãƒˆ: ç”»åƒã‚¨ãƒªã‚¢ ' + (index + 1) + ' ã‚¯ãƒªãƒƒã‚¯');
          e.preventDefault();
          e.stopPropagation();
          input.click();
        };
      }
    });
  }, 1000);
}

// æ—¢å­˜ã®ç”»åƒã‚¨ãƒªã‚¢ã‚’ä¿®å¾©ï¼ˆåˆæœŸåŒ–æ™‚ç”¨ï¼‰
function fixExistingImageAreas() {
  console.log('ğŸ”§ æ—¢å­˜ç”»åƒã‚¨ãƒªã‚¢ã®ä¿®å¾©é–‹å§‹');
  
  const imageAreas = document.querySelectorAll('.img-area');
  console.log('ç™ºè¦‹ã•ã‚ŒãŸç”»åƒã‚¨ãƒªã‚¢æ•°:', imageAreas.length);
  
  imageAreas.forEach((area, index) => {
    console.log(`ä¿®å¾©ä¸­: ç”»åƒã‚¨ãƒªã‚¢ ${index + 1}`);
    
    const input = area.querySelector('input[type="file"]');
    const deleteBtn = area.querySelector('.img-delete');
    
    if (!input || !deleteBtn) {
      console.log(`ç”»åƒã‚¨ãƒªã‚¢ ${index + 1}: å¿…è¦ãªè¦ç´ ãŒä¸è¶³ - ã‚¹ã‚­ãƒƒãƒ—`);
      return;
    }
    
    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
    area.onclick = null;
    input.onchange = null;
    deleteBtn.onclick = null;
    
    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šï¼ˆcreateImageAreaã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    area.addEventListener('click', function(e) {
      if (e.target !== deleteBtn) {
        console.log('æ—¢å­˜ç”»åƒã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯ - ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠé–‹å§‹');
        input.click();
      }
    });
    
    input.addEventListener('change', function() {
      console.log('æ—¢å­˜ç”»åƒã‚¨ãƒªã‚¢ - ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ');
      if (input.files && input.files[0]) {
        const file = input.files[0];
        console.log('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:', file.name);
        
        if (!file.type.startsWith('image/')) {
          alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        if (file.size > 5 * 1024 * 1024) {
          alert('5MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
          console.log('æ—¢å­˜ç”»åƒã‚¨ãƒªã‚¢ - ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†');
          area.innerHTML = '';
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '2px';
          area.appendChild(img);
          area.appendChild(input);
          area.appendChild(deleteBtn);
          deleteBtn.style.display = 'block';
          area.classList.add('has-image');
          
          // FirebaseåŒæœŸ
          if (isConnected && firestore) {
            setTimeout(syncDataToFirebase, 1000);
          }
        };
        reader.readAsDataURL(file);
      }
    });
    
    deleteBtn.addEventListener('click', function(e) {
      console.log('æ—¢å­˜ç”»åƒã‚¨ãƒªã‚¢ - å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
      e.stopPropagation();
      if (confirm('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        area.innerHTML = '<span style="font-size:12px;color:#888;">ğŸ“· ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯</span>';
        area.classList.remove('has-image');
        area.appendChild(input);
        area.appendChild(deleteBtn);
        deleteBtn.style.display = 'none';
        input.value = '';
        
        if (isConnected && firestore) {
          syncDataToFirebase();
        }
      }
    });
    
    console.log(`âœ… ç”»åƒã‚¨ãƒªã‚¢ ${index + 1} ä¿®å¾©å®Œäº†`);
  });
  
  console.log('ğŸ‰ æ—¢å­˜ç”»åƒã‚¨ãƒªã‚¢ä¿®å¾©å®Œäº†');
}

function forceFixImageAreas() {
  debugLog('âš¡ === å¼·åˆ¶ä¿®å¾©é–‹å§‹ ===');
  
  const imageAreas = document.querySelectorAll('.img-area');
  debugLog('å¯¾è±¡ç”»åƒã‚¨ãƒªã‚¢æ•°: ' + imageAreas.length);
  
  imageAreas.forEach((area, index) => {
    debugLog(`å¼·åˆ¶ä¿®å¾©: ç”»åƒã‚¨ãƒªã‚¢ ${index + 1}`);
    
    // å…¨ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
    area.onclick = null;
    area.removeAttribute('onclick');
    
    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
    const newArea = area.cloneNode(true);
    area.parentNode.replaceChild(newArea, area);
    
    // inputè¦ç´ ã‚’å–å¾—
    const input = newArea.querySelector('input[type="file"]');
    const deleteBtn = newArea.querySelector('.img-delete');
    
    if (!input) {
      debugLog(`  âŒ inputè¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„`);
      return;
    }
    
    debugLog(`  âœ… è¦ç´ ã‚’ç¢ºèª`);
    
    // æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    newArea.addEventListener('click', function(e) {
      debugLog('âš¡ å¼·åˆ¶ä¿®å¾©ã‚¤ãƒ™ãƒ³ãƒˆ: ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º');
      debugLog('ã‚¯ãƒªãƒƒã‚¯å¯¾è±¡: ' + e.target.tagName);
      
      // å‰Šé™¤ãƒœã‚¿ãƒ³ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
      if (e.target !== deleteBtn) {
        debugLog('input.click() å®Ÿè¡Œ');
        try {
          input.click();
          debugLog('âœ… input.click() æˆåŠŸ');
        } catch (error) {
          debugLog('âŒ input.click() ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
      }
    });
    
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
    input.addEventListener('change', function(e) {
      debugLog('âš¡ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ¤œå‡º');
      
      if (input.files && input.files[0]) {
        const file = input.files[0];
        debugLog('é¸æŠãƒ•ã‚¡ã‚¤ãƒ«: ' + file.name);
        
        if (file.size > 5 * 1024 * 1024) {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚5MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          input.value = '';
          return;
        }
        
        if (!file.type.startsWith('image/')) {
          alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          input.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
          debugLog('âš¡ ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†');
          
          // ç”»åƒã‚’è¡¨ç¤º
          newArea.innerHTML = '';
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '2px';
          newArea.appendChild(img);
          
          // inputè¦ç´ ã‚’å†è¿½åŠ 
          newArea.appendChild(input);
          
          // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’å†è¿½åŠ 
          newArea.appendChild(deleteBtn);
          deleteBtn.style.display = 'block';
          
          newArea.classList.add('has-image');
          
          debugLog('âœ… ç”»åƒè¡¨ç¤ºå®Œäº†');
          
          // FirebaseåŒæœŸ
          if (isConnected && firestore) {
            setTimeout(syncDataToFirebase, 1000);
          }
        };
        
        reader.readAsDataURL(file);
      }
    });
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    if (deleteBtn) {
      deleteBtn.addEventListener('click', function(e) {
        debugLog('âš¡ å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
        e.stopPropagation();
        
        if (confirm('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          newArea.innerHTML = '<span style="font-size:12px;color:#888;">ğŸ“· ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯</span>';
          newArea.classList.remove('has-image');
          newArea.appendChild(input);
          newArea.appendChild(deleteBtn);
          deleteBtn.style.display = 'none';
          input.value = '';
          
          if (isConnected && firestore) {
            syncDataToFirebase();
          }
        }
      });
    }
    
    debugLog(`  âœ… ç”»åƒã‚¨ãƒªã‚¢ ${index + 1} å¼·åˆ¶ä¿®å¾©å®Œäº†`);
  });
  
  debugLog('âš¡ å¼·åˆ¶ä¿®å¾©å®Œäº† - ç”»åƒã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆï¼');
}

function fixImageAreas() {
  debugLog('ğŸ”§ === ç”»åƒæ©Ÿèƒ½ä¿®å¾©é–‹å§‹ ===');
  
  const imageAreas = document.querySelectorAll('.img-area');
  debugLog('ä¿®å¾©å¯¾è±¡ã®ç”»åƒã‚¨ãƒªã‚¢æ•°: ' + imageAreas.length);
  
  let fixedCount = 0;
  
  imageAreas.forEach((area, index) => {
    debugLog(`ä¿®å¾©ä¸­: ç”»åƒã‚¨ãƒªã‚¢ ${index + 1}`);
    
    const input = area.querySelector('input[type="file"]');
    const deleteBtn = area.querySelector('.img-delete');
    const span = area.querySelector('span');
    
    if (!input || !deleteBtn) {
      debugLog(`  âŒ å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„ (input:${!!input}, deleteBtn:${!!deleteBtn})`);
      return;
    }
    
    debugLog('  âœ… å¿…è¦ãªè¦ç´ ã‚’ç¢ºèª');
    
    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
    area.onclick = null;
    input.onchange = null;
    deleteBtn.onclick = null;
    
    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    area.onclick = function(e) {
      debugLog('ğŸ–±ï¸ ç”»åƒã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯ - ä¿®å¾©ç‰ˆ');
      debugLog('ã‚¯ãƒªãƒƒã‚¯å¯¾è±¡: ' + e.target.tagName + ' (' + e.target.className + ')');
      
      // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
      if (e.target === deleteBtn) {
        debugLog('å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - input.click()ã—ãªã„');
        return;
      }
      
      e.preventDefault();
      e.stopPropagation();
      
      debugLog('input.click() å®Ÿè¡Œé–‹å§‹');
      try {
        input.click();
        debugLog('input.click() æˆåŠŸ - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ãã¯ãš');
      } catch (error) {
        debugLog('input.click() ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    };
    
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
    input.onchange = function(e) {
      debugLog('ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ - ä¿®å¾©ç‰ˆ');
      debugLog('é¸æŠãƒ•ã‚¡ã‚¤ãƒ«æ•°: ' + (input.files ? input.files.length : 0));
      
      if (!input.files || !input.files[0]) {
        debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„');
        return;
      }
      
      const file = input.files[0];
      debugLog('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ' + file.name + ' (' + Math.round(file.size/1024) + 'KB)');
      
      // ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
      if (file.size > 5 * 1024 * 1024) {
        debugLog('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼');
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚5MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        input.value = '';
        return;
      }
      
      if (!file.type.startsWith('image/')) {
        debugLog('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚¨ãƒ©ãƒ¼');
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        input.value = '';
        return;
      }
      
      debugLog('âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼OK - èª­ã¿è¾¼ã¿é–‹å§‹');
      
      const reader = new FileReader();
      reader.onload = function(event) {
        debugLog('ğŸ“· ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†');
        
        try {
          // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
          area.innerHTML = '';
          
          // ç”»åƒã‚’ä½œæˆ
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '2px';
          area.appendChild(img);
          
          // inputè¦ç´ ã‚’å†è¿½åŠ 
          area.appendChild(input);
          
          // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’å†è¿½åŠ 
          area.appendChild(deleteBtn);
          deleteBtn.style.display = 'block';
          
          // has-imageã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
          area.classList.add('has-image');
          
          debugLog('âœ… ç”»åƒè¡¨ç¤ºå®Œäº†');
          
          // FirebaseåŒæœŸï¼ˆæ¥ç¶šæ™‚ã®ã¿ï¼‰
          if (isConnected && firestore) {
            debugLog('ğŸ”„ FirebaseåŒæœŸé–‹å§‹');
            setTimeout(syncDataToFirebase, 1000);
          }
          
        } catch (error) {
          debugLog('âŒ ç”»åƒè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
      };
      
      reader.onerror = function() {
        debugLog('âŒ ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
        alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        input.value = '';
      };
      
      reader.readAsDataURL(file);
    };
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    deleteBtn.onclick = function(e) {
      debugLog('ğŸ—‘ï¸ å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
      e.preventDefault();
      e.stopPropagation();
      
      if (confirm('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        debugLog('ç”»åƒå‰Šé™¤å®Ÿè¡Œ');
        
        // å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
        area.innerHTML = '<span style="font-size:12px;color:#888;">ğŸ“· ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯</span>';
        area.classList.remove('has-image');
        
        // è¦ç´ ã‚’å†è¿½åŠ 
        input.value = '';
        area.appendChild(input);
        area.appendChild(deleteBtn);
        deleteBtn.style.display = 'none';
        
        debugLog('ç”»åƒå‰Šé™¤å®Œäº†');
        
        // FirebaseåŒæœŸ
        if (isConnected && firestore) {
          syncDataToFirebase();
        }
      }
    };
    
    fixedCount++;
    debugLog(`  âœ… ç”»åƒã‚¨ãƒªã‚¢ ${index + 1} ä¿®å¾©å®Œäº†`);
  });
  
  debugLog(`ğŸ‰ ä¿®å¾©å®Œäº†: ${fixedCount}å€‹ã®ç”»åƒã‚¨ãƒªã‚¢ã‚’ä¿®å¾©ã—ã¾ã—ãŸ`);
  debugLog('ğŸ“· ç”»åƒã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼');
}

// ========== ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ ==========

function debugLog(message) {
  console.log(message);
  const debugOutput = document.getElementById('debugOutput');
  if (debugOutput) {
    debugOutput.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '\n';
    debugOutput.scrollTop = debugOutput.scrollHeight;
  }
}

function testImageAreaCreation() {
  debugLog('=== ç”»åƒã‚¨ãƒªã‚¢ä½œæˆãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
  
  try {
    const testDiv = createImageArea();
    debugLog('ç”»åƒã‚¨ãƒªã‚¢ä½œæˆæˆåŠŸ');
    debugLog('è¦ç´ ã‚¯ãƒ©ã‚¹: ' + testDiv.className);
    debugLog('å­è¦ç´ æ•°: ' + testDiv.children.length);
    
    // ãƒ†ã‚¹ãƒˆç”¨ã®å ´æ‰€ã«è¿½åŠ 
    const testContainer = document.getElementById('debugOutput');
    testContainer.appendChild(testDiv);
    debugLog('ãƒ†ã‚¹ãƒˆç”»åƒã‚¨ãƒªã‚¢ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆä¸Šè¨˜ã«è¡¨ç¤ºï¼‰');
    
  } catch (error) {
    debugLog('ç”»åƒã‚¨ãƒªã‚¢ä½œæˆã‚¨ãƒ©ãƒ¼: ' + error.message);
  }
}

function testClickEvents() {
  debugLog('=== ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
  
  const imageAreas = document.querySelectorAll('.img-area');
  debugLog('ç”»åƒã‚¨ãƒªã‚¢æ•°: ' + imageAreas.length);
  
  imageAreas.forEach((area, index) => {
    debugLog(`ç”»åƒã‚¨ãƒªã‚¢ ${index + 1}:`);
    debugLog('  - ID: ' + (area.id || 'ãªã—'));
    debugLog('  - ã‚¯ãƒ©ã‚¹: ' + area.className);
    debugLog('  - data-debug: ' + (area.getAttribute('data-debug') || 'ãªã—'));
    
    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºèª
    debugLog('  - onclickè¨­å®šæ¸ˆã¿: ' + (area.onclick ? 'ã‚ã‚Š' : 'ãªã—'));
    
    // æ‰‹å‹•ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
    const input = area.querySelector('input[type="file"]');
    const deleteBtn = area.querySelector('.img-delete');
    
    if (input && deleteBtn) {
      debugLog('  - inputè¦ç´ : ç™ºè¦‹');
      debugLog('  - deleteBtn: ç™ºè¦‹');
      
      // å¼·åˆ¶çš„ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
      area.onclick = function(e) {
        debugLog('=== æ‰‹å‹•è¨­å®šonclick ã§ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º ===');
        debugLog('ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ : ' + e.target.tagName + '.' + e.target.className);
        
        if (e.target === deleteBtn) {
          debugLog('å‰Šé™¤ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
          return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        debugLog('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã¾ã™');
        try {
          input.click();
          debugLog('input.click() å®Ÿè¡ŒæˆåŠŸ');
        } catch (error) {
          debugLog('input.click() ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
      };
      
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆã‚‚å†è¨­å®š
      input.onchange = function(e) {
        debugLog('=== ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ‰‹å‹•è¨­å®šï¼‰ ===');
        debugLog('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: ' + (input.files ? input.files.length : 0));
        
        if (input.files && input.files[0]) {
          const file = input.files[0];
          debugLog('ãƒ•ã‚¡ã‚¤ãƒ«å: ' + file.name);
          debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ' + file.size);
          debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: ' + file.type);
          
          if (file.size > 5 * 1024 * 1024) {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚5MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            input.value = '';
            return;
          }
          
          if (!file.type.startsWith('image/')) {
            alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            input.value = '';
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(event) {
            debugLog('ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†');
            
            // ç”»åƒã‚’è¡¨ç¤º
            area.innerHTML = '';
            const img = document.createElement('img');
            img.src = event.target.result;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '2px';
            area.appendChild(img);
            
            // è¦ç´ ã‚’å†è¿½åŠ 
            area.appendChild(input);
            area.appendChild(deleteBtn);
            deleteBtn.style.display = 'block';
            area.classList.add('has-image');
            
            debugLog('ç”»åƒè¡¨ç¤ºå®Œäº†');
          };
          
          reader.onerror = function() {
            debugLog('ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
            alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          reader.readAsDataURL(file);
        }
      };
      
      debugLog('  - ã‚¤ãƒ™ãƒ³ãƒˆå†è¨­å®šå®Œäº†');
    } else {
      debugLog('  - inputè¦ç´ ã¾ãŸã¯deleteBtnãŒè¦‹ã¤ã‹ã‚‰ãªã„');
    }
  });
  
  debugLog('å…¨ã¦ã®ç”»åƒã‚¨ãƒªã‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®šã—ã¾ã—ãŸ');
  debugLog('ç”»åƒã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼');
}

function inspectImageAreas() {
  debugLog('=== ç”»åƒã‚¨ãƒªã‚¢æ¤œæŸ»é–‹å§‹ ===');
  
  const imageAreas = document.querySelectorAll('.img-area');
  debugLog('ç™ºè¦‹ã•ã‚ŒãŸç”»åƒã‚¨ãƒªã‚¢æ•°: ' + imageAreas.length);
  
  imageAreas.forEach((area, index) => {
    debugLog(`\n--- ç”»åƒã‚¨ãƒªã‚¢ ${index + 1} ---`);
    debugLog('è¦ç´ ã‚¿ã‚¤ãƒ—: ' + area.tagName);
    debugLog('ã‚¯ãƒ©ã‚¹: ' + area.className);
    debugLog('ã‚¹ã‚¿ã‚¤ãƒ«è¡¨ç¤º: ' + window.getComputedStyle(area).display);
    debugLog('ã‚¹ã‚¿ã‚¤ãƒ«å¯è¦–æ€§: ' + window.getComputedStyle(area).visibility);
    debugLog('ä½ç½®: x=' + area.offsetLeft + ', y=' + area.offsetTop);
    debugLog('ã‚µã‚¤ã‚º: w=' + area.offsetWidth + ', h=' + area.offsetHeight);
    debugLog('innerHTML: ' + area.innerHTML.substring(0, 100));
    
    // å­è¦ç´ ã®ç¢ºèª
    debugLog('å­è¦ç´ æ•°: ' + area.children.length);
    for (let i = 0; i < area.children.length; i++) {
      const child = area.children[i];
      debugLog(`  å­è¦ç´  ${i + 1}: ${child.tagName}.${child.className}`);
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç¢ºèªï¼ˆè¿‘ä¼¼ï¼‰
    const events = [];
    if (area.onclick) events.push('onclick');
    if (area.addEventListener.toString().includes('click')) events.push('addEventListener');
    debugLog('ã‚¤ãƒ™ãƒ³ãƒˆ: ' + (events.length ? events.join(', ') : 'ãªã—'));
  });
}

// ========== Firebaseé–¢é€£æ©Ÿèƒ½ ==========

function showFirebaseConfig() {
  document.getElementById('firebaseModal').style.display = 'block';
  
  // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿
  const savedConfig = getStoredFirebaseConfig();
  const savedUserName = getStoredUserName();
  
  if (savedConfig) {
    document.getElementById('firebaseConfig').value = JSON.stringify(savedConfig, null, 2);
  }
  if (savedUserName) {
    document.getElementById('userName').value = savedUserName;
  }
}

function hideFirebaseConfig() {
  document.getElementById('firebaseModal').style.display = 'none';
}

function loadSampleConfig() {
  const sampleConfig = {
    "apiKey": "AIzaSyCxTWcFJksdtGYKUo3B_tNpXyjJ6bPlcXU",
    "authDomain": "ipsheet-11633.firebaseapp.com",
    "projectId": "ipsheet-11633",
    "storageBucket": "ipsheet-11633.firebasestorage.app",
    "messagingSenderId": "315180897561",
    "appId": "1:315180897561:web:339f254e1f227f8b432188",
    "measurementId": "G-7HXRKLJCNB"
  };
  
  document.getElementById('firebaseConfig').value = JSON.stringify(sampleConfig, null, 2);
  document.getElementById('userName').value = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
}

function saveFirebaseConfig() {
  const userName = document.getElementById('userName').value.trim();
  const configText = document.getElementById('firebaseConfig').value.trim();
  
  if (!userName) {
    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  if (!configText) {
    alert('Firebaseè¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  try {
    const config = JSON.parse(configText);
    
    // å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
    const requiredFields = ['apiKey', 'authDomain', 'projectId'];
    const missingFields = requiredFields.filter(field => !config[field]);
    
    if (missingFields.length > 0) {
      alert(`ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™: ${missingFields.join(', ')}`);
      return;
    }
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('firebaseConfig', JSON.stringify(config));
    localStorage.setItem('userName', userName);
    
    // æ¥ç¶šãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    const connectBtn = document.getElementById('connectBtn');
    if (typeof firebase !== 'undefined') {
      connectBtn.disabled = false;
      connectBtn.textContent = 'æ¥ç¶š';
    } else {
      connectBtn.textContent = 'Firebaseèª­ã¿è¾¼ã¿ä¸­...';
    }
    
    hideFirebaseConfig();
    alert('Firebaseè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚Firebase SDKã®èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€ã€Œæ¥ç¶šã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    
  } catch (error) {
    alert('Firebaseè¨­å®šã®JSONãŒç„¡åŠ¹ã§ã™ã€‚æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
  }
}

function getStoredFirebaseConfig() {
  const configStr = localStorage.getItem('firebaseConfig');
  return configStr ? JSON.parse(configStr) : null;
}

function getStoredUserName() {
  return localStorage.getItem('userName');
}

function updateConnectionStatus(connected) {
  const statusDiv = document.getElementById('connectionStatus');
  const indicator = statusDiv.querySelector('.status-indicator');
  const text = statusDiv.querySelector('span');
  
  if (connected) {
    statusDiv.className = 'connection-status status-connected';
    indicator.className = 'status-indicator indicator-connected';
    text.textContent = 'Firebaseæ¥ç¶šä¸­';
  } else {
    statusDiv.className = 'connection-status status-disconnected';
    indicator.className = 'status-indicator indicator-disconnected';
    text.textContent = 'Firebaseæœªæ¥ç¶š';
  }
}

function connectToFirebase() {
  // Firebase SDKã®èª­ã¿è¾¼ã¿ãƒã‚§ãƒƒã‚¯
  if (typeof firebase === 'undefined') {
    console.error('Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }
  
  // å›ºå®šFirebaseè¨­å®š
  const config = {
    "apiKey": "AIzaSyCxTWcFJksdtGYKUo3B_tNpXyjJ6bPlcXU",
    "authDomain": "ipsheet-11633.firebaseapp.com",
    "projectId": "ipsheet-11633",
    "storageBucket": "ipsheet-11633.firebasestorage.app",
    "messagingSenderId": "315180897561",
    "appId": "1:315180897561:web:339f254e1f227f8b432188",
    "measurementId": "G-7HXRKLJCNB"
  };
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã¾ãŸã¯ç”Ÿæˆ
  let userName = getStoredUserName();
  if (!userName) {
    userName = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' + Math.floor(Math.random() * 1000);
    localStorage.setItem('userName', userName);
  }
  
  try {
    // FirebaseåˆæœŸåŒ–
    if (firebaseApp) {
      firebaseApp.delete();
    }
    
    firebaseApp = firebase.initializeApp(config);
    firestore = firebase.firestore();
    currentUser = userName;
    isConnected = true;
    
    updateConnectionStatus(true);
    
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    loadProjectList();
    
    // UIæ›´æ–°
    document.getElementById('currentUser').textContent = userName;
    
    console.log('Firebaseæ¥ç¶šæˆåŠŸ');
    
  } catch (error) {
    console.error('Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
    updateConnectionStatus(false);
  }
}

function disconnectFromFirebase() {
  if (firebaseApp) {
    // ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹å‰Šé™¤
    if (currentProjectId && currentUser) {
      firestore.collection('projects').doc(currentProjectId).collection('users').doc(currentUser).delete();
    }
    
    // ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ›´æ–°ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
    if (presenceUpdateInterval) {
      clearInterval(presenceUpdateInterval);
      presenceUpdateInterval = null;
    }
    
    firebaseApp.delete();
    firebaseApp = null;
    firestore = null;
    currentUser = null;
    currentProjectId = null;
    isConnected = false;
    onlineUsers = {};
    
    updateConnectionStatus(false);
    document.getElementById('connectBtn').disabled = false;
    document.getElementById('disconnectBtn').disabled = true;
    document.getElementById('currentUser').textContent = 'æœªè¨­å®š';
    document.getElementById('currentProject').textContent = 'ãªã—';
    document.getElementById('onlineUsersList').innerHTML = '';
    
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã‚’ã‚¯ãƒªã‚¢
    document.getElementById('projectSelect').innerHTML = '<option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ</option>';
  }
}

function updateConnectionStatus(connected) {
  const statusDiv = document.getElementById('connectionStatus');
  const indicator = statusDiv.querySelector('.status-indicator');
  const text = statusDiv.querySelector('span');
  
  if (connected) {
    statusDiv.className = 'connection-status status-connected';
    indicator.className = 'status-indicator indicator-connected';
    text.textContent = 'Firebaseæ¥ç¶šä¸­';
  } else {
    statusDiv.className = 'connection-status status-disconnected';
    indicator.className = 'status-indicator indicator-disconnected';
    text.textContent = 'Firebaseæœªæ¥ç¶š';
  }
}

function setupUserPresence() {
  if (!firestore || !currentProjectId || !currentUser) return;
  
  const userRef = firestore.collection('projects').doc(currentProjectId).collection('users').doc(currentUser);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¨­å®š
  userRef.set({
    name: currentUser,
    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
    online: true
  });
  
  // å®šæœŸçš„ã«lastSeenã‚’æ›´æ–°ï¼ˆ30ç§’ã”ã¨ï¼‰
  presenceUpdateInterval = setInterval(() => {
    if (firestore && currentProjectId && currentUser) {
      userRef.update({
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        online: true
      });
    }
  }, 30000);
  
  // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’ç›£è¦–
  firestore.collection('projects').doc(currentProjectId).collection('users')
    .onSnapshot((snapshot) => {
      onlineUsers = {};
      const now = Date.now();
      
      snapshot.forEach((doc) => {
        const userData = doc.data();
        const lastSeen = userData.lastSeen ? userData.lastSeen.toMillis() : 0;
        
        // 5åˆ†ä»¥å†…ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒã‚ã‚Œã°ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã¨ã¿ãªã™
        if (now - lastSeen < 5 * 60 * 1000) {
          onlineUsers[doc.id] = userData;
        }
      });
      
      updateOnlineUsersList();
    });
}

function updateOnlineUsersList() {
  const listDiv = document.getElementById('onlineUsersList');
  listDiv.innerHTML = '';
  
  Object.keys(onlineUsers).forEach(userName => {
    const badge = document.createElement('span');
    badge.className = 'user-badge';
    if (userName === currentUser) {
      badge.className += ' current';
    }
    badge.textContent = userName;
    listDiv.appendChild(badge);
  });
}

// ========== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† ==========

function createNewProject() {
  if (!firestore) {
    alert('Firebaseã«æ¥ç¶šã—ã¦ãã ã•ã„');
    return;
  }
  
  const projectName = document.getElementById('projectName').value.trim();
  if (!projectName) {
    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  const projectId = generateProjectId();
  const projectData = {
    name: projectName,
    createdBy: currentUser,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    data: getCurrentData()
  };
  
  firestore.collection('projects').doc(projectId).set(projectData)
    .then(() => {
      currentProjectId = projectId;
      document.getElementById('currentProject').textContent = projectName;
      document.getElementById('projectName').value = '';
      loadProjectList();
      setupUserPresence();
      setupDataSync();
      alert(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${projectName}ã€ã‚’ä½œæˆã—ã¾ã—ãŸ`);
    })
    .catch((error) => {
      alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    });
}

function loadProject() {
  if (!firestore) {
    alert('Firebaseã«æ¥ç¶šã—ã¦ãã ã•ã„');
    return;
  }
  
  const projectId = document.getElementById('projectSelect').value;
  if (!projectId) {
    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  firestore.collection('projects').doc(projectId).get()
    .then((doc) => {
      if (doc.exists) {
        const project = doc.data();
        currentProjectId = projectId;
        document.getElementById('currentProject').textContent = project.name;
        
        if (project.data) {
          restoreData(project.data);
        }
        
        setupUserPresence();
        setupDataSync();
        alert(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${project.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      } else {
        alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
    })
    .catch((error) => {
      alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    });
}

function deleteProject() {
  if (!firestore) {
    alert('Firebaseã«æ¥ç¶šã—ã¦ãã ã•ã„');
    return;
  }
  
  const projectId = document.getElementById('projectSelect').value;
  if (!projectId) {
    alert('å‰Šé™¤ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  if (!confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
    return;
  }
  
  firestore.collection('projects').doc(projectId).delete()
    .then(() => {
      if (currentProjectId === projectId) {
        currentProjectId = null;
        document.getElementById('currentProject').textContent = 'ãªã—';
      }
      loadProjectList();
      alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    })
    .catch((error) => {
      alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    });
}

function loadProjectList() {
  if (!firestore) return;
  
  const select = document.getElementById('projectSelect');
  select.innerHTML = '<option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ</option>';
  
  firestore.collection('projects').get()
    .then((querySnapshot) => {
      querySnapshot.forEach((doc) => {
        const project = doc.data();
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = `${project.name} (ä½œæˆè€…: ${project.createdBy})`;
        select.appendChild(option);
      });
    })
    .catch((error) => {
      console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—:', error);
    });
}

function generateProjectId() {
  return 'proj_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// ========== ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿åŒæœŸ ==========

function setupDataSync() {
  if (!firestore || !currentProjectId) return;
  
  const projectRef = firestore.collection('projects').doc(currentProjectId);
  
  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’ç›£è¦–
  projectRef.onSnapshot((doc) => {
    if (doc.exists) {
      const project = doc.data();
      if (project.data && project.data.lastUpdatedBy !== currentUser) {
        // ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹æ›´æ–°ã®å ´åˆã®ã¿åæ˜ 
        restoreData(project.data);
      }
    }
  });
  
  // ç·¨é›†ä¸­çŠ¶æ³ã‚’ç›£è¦–
  firestore.collection('projects').doc(currentProjectId).collection('editing')
    .onSnapshot((snapshot) => {
      const editingData = {};
      snapshot.forEach((doc) => {
        editingData[doc.id] = doc.data();
      });
      updateEditingIndicators(editingData);
    });
}

function syncDataToFirebase() {
  if (!firestore || !currentProjectId || !currentUser) {
    console.log('FirebaseåŒæœŸã‚¹ã‚­ãƒƒãƒ— - æ¥ç¶šãªã—');
    return;
  }
  
  try {
    const data = getCurrentData();
    data.lastUpdatedBy = currentUser;
    data.lastUpdatedAt = firebase.firestore.FieldValue.serverTimestamp();
    
    console.log('FirebaseåŒæœŸé–‹å§‹...');
    firestore.collection('projects').doc(currentProjectId).update({
      data: data
    })
      .then(() => {
        console.log('FirebaseåŒæœŸæˆåŠŸ');
      })
      .catch((error) => {
        console.warn('FirebaseåŒæœŸã‚¨ãƒ©ãƒ¼ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ç¶™ç¶šï¼‰:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç¶™ç¶šå‹•ä½œ
      });
      
  } catch (error) {
    console.warn('FirebaseåŒæœŸå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
  }
}

function notifyEditing(elementId, isEditing) {
  if (!firestore || !currentProjectId || !currentUser) return;
  
  const editingRef = firestore.collection('projects').doc(currentProjectId).collection('editing').doc(elementId);
  
  if (isEditing) {
    editingRef.set({
      user: currentUser,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      editingRef.delete();
    }, 5000);
  } else {
    editingRef.delete();
  }
}

function updateEditingIndicators(editingData) {
  // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
  document.querySelectorAll('.editing-indicator').forEach(indicator => {
    indicator.remove();
  });
  
  // æ–°ã—ã„ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¿½åŠ 
  Object.keys(editingData).forEach(elementId => {
    const editingInfo = editingData[elementId];
    if (editingInfo.user !== currentUser) {
      const element = document.getElementById(elementId) || document.querySelector(`[data-element-id="${elementId}"]`);
      if (element) {
        const indicator = document.createElement('div');
        indicator.className = 'editing-indicator';
        indicator.textContent = `${editingInfo.user}ãŒç·¨é›†ä¸­`;
        element.style.position = 'relative';
        element.appendChild(indicator);
      }
    }
  });
}

// ========== å…ƒã®æ©Ÿèƒ½ã‚’æ‹¡å¼µ ==========

// ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¹…ã‚’è¨ˆç®—ã—ã¦è¨­å®š
function calculateTableWidth() {
  const table = document.getElementById('mainTable');
  const categoryWidth = 200; // ã‚«ãƒ†ã‚´ãƒªåˆ—ã®å¹…
  const weekWidth = 180; // å„é€±åˆ—ã®å¹…
  const visibleWeeks = weeks.filter(week => !hiddenWeeks.has(week));
  const totalWidth = categoryWidth + (weekWidth * visibleWeeks.length);
  
  table.style.width = totalWidth + 'px';
}

// ã‚ºãƒ¼ãƒ æ©Ÿèƒ½
function updateZoom(value) {
  currentZoom = parseInt(value);
  const table = document.getElementById('mainTable');
  const zoomDisplay = document.getElementById('zoomDisplay');
  
  table.style.transform = `scale(${currentZoom / 100})`;
  zoomDisplay.textContent = currentZoom + '%';
  
  // ã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ã‚’èª¿æ•´
  const container = document.getElementById('tableContainer');
  if (currentZoom !== 100) {
    container.style.height = `${80 * (100 / currentZoom)}vh`;
  } else {
    container.style.height = '80vh';
  }
}

function resetZoom() {
  document.getElementById('zoomSlider').value = 100;
  updateZoom(100);
}

// ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã®åˆæœŸåŒ–
function initializeResizing() {
  const tableContainer = document.getElementById('tableContainer');
  
  // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒªã‚µã‚¤ã‚ºé–‹å§‹ï¼‰
  tableContainer.addEventListener('mousedown', function(e) {
    if (e.target.classList.contains('resize-handle')) {
      isResizing = true;
      resizingColumn = e.target.parentElement;
      startX = e.clientX;
      startWidth = resizingColumn.offsetWidth;
      
      // ãƒªã‚µã‚¤ã‚ºãƒ©ã‚¤ãƒ³è¡¨ç¤º
      resizeLine = document.createElement('div');
      resizeLine.className = 'resize-line';
      resizeLine.style.left = e.clientX + 'px';
      document.body.appendChild(resizeLine);
      
      document.body.classList.add('resizing');
      e.preventDefault();
    }
  });
  
  // ãƒã‚¦ã‚¹ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒªã‚µã‚¤ã‚ºä¸­ï¼‰
  document.addEventListener('mousemove', function(e) {
    if (!isResizing) return;
    
    const diff = e.clientX - startX;
    const newWidth = Math.max(100, startWidth + diff); // æœ€å°å¹…100px
    
    // ãƒªã‚µã‚¤ã‚ºãƒ©ã‚¤ãƒ³ç§»å‹•
    if (resizeLine) {
      resizeLine.style.left = e.clientX + 'px';
    }
    
    e.preventDefault();
  });
  
  // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒªã‚µã‚¤ã‚ºçµ‚äº†ï¼‰
  document.addEventListener('mouseup', function(e) {
    if (!isResizing) return;
    
    const diff = e.clientX - startX;
    const newWidth = Math.max(100, startWidth + diff);
    
    // åˆ—å¹…ã‚’å®Ÿéš›ã«å¤‰æ›´
    if (resizingColumn) {
      resizingColumn.style.width = newWidth + 'px';
      
      // åŒã˜é€±ã®å…¨ã¦ã®ã‚»ãƒ«ã®å¹…ã‚’å¤‰æ›´
      const weekData = resizingColumn.dataset.week;
      if (weekData) {
        const allCells = document.querySelectorAll(`[data-week="${weekData}"]`);
        allCells.forEach(cell => {
          cell.style.width = newWidth + 'px';
        });
      } else if (resizingColumn.classList.contains('category-column')) {
        // ã‚«ãƒ†ã‚´ãƒªåˆ—ã®å ´åˆ
        const allCategoryCells = document.querySelectorAll('.category-column');
        allCategoryCells.forEach(cell => {
          cell.style.width = newWidth + 'px';
        });
      }
    }
    
    // ãƒªã‚µã‚¤ã‚ºãƒ©ã‚¤ãƒ³å‰Šé™¤
    if (resizeLine) {
      document.body.removeChild(resizeLine);
      resizeLine = null;
    }
    
    isResizing = false;
    resizingColumn = null;
    document.body.classList.remove('resizing');
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®å¹…ã‚’å†è¨ˆç®—
    updateTableWidth();
  });
}

// ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®å¹…ã‚’æ›´æ–°
function updateTableWidth() {
  const table = document.getElementById('mainTable');
  const headerRow = document.getElementById('headerRow');
  const cells = headerRow.querySelectorAll('th');
  let totalWidth = 0;
  
  cells.forEach(cell => {
    if (!cell.classList.contains('week-column-hidden')) {
      totalWidth += cell.offsetWidth;
    }
  });
  
  table.style.width = totalWidth + 'px';
}

// ç”»åƒã‚¨ãƒªã‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function setupImageAreaEvents(imgArea, input, deleteBtn) {
  // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ä»¥å¤–ï¼‰
  imgArea.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (e.target !== deleteBtn) {
      console.log('ç”»åƒã‚¨ãƒªã‚¢ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      input.click();
    }
  });
  
  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
  input.addEventListener('change', function(e) {
    console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', input.files);
    if (input.files && input.files[0]) {
      const file = input.files[0];
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBåˆ¶é™ï¼‰
      if (file.size > 5 * 1024 * 1024) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚5MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        input.value = '';
        return;
      }
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
      if (!file.type.startsWith('image/')) {
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        input.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        console.log('ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†');
        // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
        imgArea.innerHTML = '';
        
        // ç”»åƒè¦ç´ ã‚’ä½œæˆ
        const img = document.createElement('img');
        img.src = event.target.result;
        img.alt = 'ç”»åƒ';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        imgArea.appendChild(img);
        
        // å…¥åŠ›è¦ç´ ã‚’å†è¿½åŠ ï¼ˆéè¡¨ç¤ºï¼‰
        imgArea.appendChild(input);
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’å†è¿½åŠ 
        imgArea.appendChild(deleteBtn);
        deleteBtn.style.display = 'block';
        
        imgArea.classList.add('has-image');
        
        // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        setTimeout(syncDataToFirebase, 1000);
      };
      
      reader.onerror = function() {
        alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        input.value = '';
      };
      
      reader.readAsDataURL(file);
    }
  });
  
  // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  deleteBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('ç”»åƒå‰Šé™¤ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    
    if (confirm('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      // å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
      imgArea.innerHTML = '<span style="font-size:12px;color:#888;">ç”»åƒ</span>';
      imgArea.classList.remove('has-image');
      
      // è¦ç´ ã‚’å†è¿½åŠ 
      input.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      imgArea.appendChild(input);
      imgArea.appendChild(deleteBtn);
      deleteBtn.style.display = 'none';
      
      // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
      syncDataToFirebase();
    }
  });
}

// ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é ˜åŸŸã‚’ä½œæˆ
// ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é ˜åŸŸã‚’ä½œæˆ
function createImageArea() {
  const div = document.createElement('div');
  div.className = 'img-area';
  div.innerHTML = '<span style="font-size:12px;color:#888;">ğŸ“· ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯</span>';

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.style.display = 'none';

  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'img-delete';
  deleteBtn.innerHTML = 'Ã—';
  deleteBtn.style.display = 'none';

  // ã‚¯ãƒªãƒƒã‚¯ã§inputã‚’é–‹ãï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ä»¥å¤–ï¼‰
  div.addEventListener('click', function(e) {
    if (e.target !== deleteBtn) {
      console.log('ç”»åƒã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯ - ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠé–‹å§‹');
      input.click();
    }
  });

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚
  input.addEventListener('change', function() {
    console.log('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ');
    if (input.files && input.files[0]) {
      const file = input.files[0];
      console.log('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:', file.name);
      
      if (!file.type.startsWith('image/')) {
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        alert('5MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        console.log('ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†');
        div.innerHTML = '';
        const img = document.createElement('img');
        img.src = event.target.result;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '2px';
        div.appendChild(img);
        div.appendChild(input);
        div.appendChild(deleteBtn);
        deleteBtn.style.display = 'block';
        div.classList.add('has-image');
        
        // FirebaseåŒæœŸ
        if (isConnected && firestore) {
          setTimeout(syncDataToFirebase, 1000);
        }
      };
      reader.readAsDataURL(file);
    }
  });

  // å‰Šé™¤ãƒœã‚¿ãƒ³
  deleteBtn.addEventListener('click', function(e) {
    console.log('å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
    e.stopPropagation();
    if (confirm('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      div.innerHTML = '<span style="font-size:12px;color:#888;">ğŸ“· ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯</span>';
      div.classList.remove('has-image');
      div.appendChild(input);
      div.appendChild(deleteBtn);
      deleteBtn.style.display = 'none';
      input.value = '';
      
      // FirebaseåŒæœŸ
      if (isConnected && firestore) {
        syncDataToFirebase();
      }
    }
  });

  div.appendChild(input);
  div.appendChild(deleteBtn);
  return div;
}

// å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰é€±ã‚’è¿½åŠ 
function addWeekFromInput() {
  const input = document.getElementById('weekInput');
  const weekString = input.value.trim();
  
  if (!weekString) {
    alert('é€±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 7/8, 12/25ï¼‰');
    return;
  }
  
  // æ—¥ä»˜å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
  const datePattern = /^\d{1,2}\/\d{1,2}$/;
  if (!datePattern.test(weekString)) {
    alert('æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 7/8, 12/25ï¼‰');
    return;
  }
  
  // æ—¢å­˜ã®é€±ã‹ãƒã‚§ãƒƒã‚¯
  if (weeks.includes(weekString)) {
    alert('ã“ã®é€±ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
    return;
  }
  
  // é€±ã‚’è¿½åŠ 
  addWeek(weekString);
  
  // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
  input.value = '';
  
  alert(`é€±ã€Œ${weekString}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
}

// é€±ã‚’è¿½åŠ ï¼ˆå…±é€šå‡¦ç†ï¼‰
function addWeek(weekString) {
  weeks.push(weekString);
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã«é€±ã‚’è¿½åŠ 
  const headerRow = document.getElementById('headerRow');
  const th = document.createElement('th');
  th.dataset.week = weekString;
  th.className = 'week-column';
  
  th.innerHTML = `
    <div class="week-header">
      <span>${weekString}</span>
      <button class="toggle-btn" onclick="toggleWeekVisibility('${weekString}')">éè¡¨ç¤º</button>
    </div>
    <div class="resize-handle"></div>
  `;
  
  headerRow.appendChild(th);
  
  // æ—¢å­˜ã®å„è¡Œã«æ–°ã—ã„é€±ã®åˆ—ã‚’è¿½åŠ 
  const tableBody = document.getElementById('tableBody');
  const rows = tableBody.querySelectorAll('tr');
  rows.forEach(row => {
    const td = document.createElement('td');
    td.dataset.week = weekString;
    td.className = 'week-column';
    
    // createImageArea()ã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚¨ãƒªã‚¢ã‚’ä½œæˆ
    const imgArea = createImageArea();
    td.appendChild(imgArea);
    
    td.innerHTML += `
      <br>URL: <input type="text" placeholder="BOX URL" oninput="handleInputChange(this)">
      <br>ã‚«ãƒ†ã‚´ãƒª: <select onchange="handleInputChange(this)">
        <option>ãƒ‡ã‚¶ã‚¤ãƒ³</option>
        <option>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</option>
        <option>å ´é¢å†™</option>
      </select>
      <br>æ•°é‡: <input type="number" placeholder="0" oninput="handleInputChange(this)">
    `;
    
    row.appendChild(td);
  });
  
  calculateTableWidth();
  
  // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
  syncDataToFirebase();
}

// é€±ã‚’è¿½åŠ 
function addWeekFromDate(date) {
  const selectedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  const month = selectedDate.getMonth() + 1;
  const day = selectedDate.getDate();
  const weekString = `${month}/${day}`;
  
  if (weeks.includes(weekString)) {
    alert('ã“ã®é€±ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
    return;
  }
  
  // å…±é€šã®é€±è¿½åŠ å‡¦ç†ã‚’ä½¿ç”¨
  addWeek(weekString);
  
  alert(`é€±ã€Œ${weekString}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
  document.getElementById('calendarContainer').style.display = 'none';
}

// å…¥åŠ›å¤‰æ›´ã®å‡¦ç†
function handleInputChange(element) {
  // ç·¨é›†ä¸­ã®é€šçŸ¥
  const elementId = generateElementId(element);
  notifyEditing(elementId, true);
  
  // é…å»¶åŒæœŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã‚’å®Œäº†ã—ã¦ã‹ã‚‰åŒæœŸï¼‰
  clearTimeout(editingTimeouts[elementId]);
  editingTimeouts[elementId] = setTimeout(() => {
    syncDataToFirebase();
    notifyEditing(elementId, false);
  }, 1000);
}

function generateElementId(element) {
  // è¦ç´ ã®ä½ç½®ã‚’åŸºã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ
  const row = element.closest('tr');
  const cell = element.closest('td');
  const rowIndex = Array.from(row.parentElement.children).indexOf(row);
  const cellIndex = cell ? Array.from(row.children).indexOf(cell) : 0;
  const inputIndex = Array.from(cell?.querySelectorAll('input, select') || []).indexOf(element);
  
  return `cell_${rowIndex}_${cellIndex}_${inputIndex}`;
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
function toggleCalendar() {
  const container = document.getElementById('calendarContainer');
  if (container.style.display === 'none') {
    currentCalendarDate = new Date();
    container.style.display = 'block';
    renderCalendar();
  } else {
    container.style.display = 'none';
  }
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
function renderCalendar() {
  const year = currentCalendarDate.getFullYear();
  const month = currentCalendarDate.getMonth();
  
  const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
  document.getElementById('currentMonth').textContent = `${year}å¹´ ${monthNames[month]}`;
  
  const calendarBody = document.getElementById('calendarBody');
  calendarBody.innerHTML = '';
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDate = new Date(firstDay);
  startDate.setDate(firstDay.getDate() - firstDay.getDay());
  
  for (let week = 0; week < 6; week++) {
    const row = document.createElement('tr');
    
    for (let day = 0; day < 7; day++) {
      const currentDate = new Date(startDate);
      currentDate.setDate(startDate.getDate() + (week * 7) + day);
      
      const cell = document.createElement('td');
      cell.className = 'calendar-day';
      cell.textContent = currentDate.getDate();
      
      if (currentDate.getMonth() !== month) {
        cell.classList.add('other-month');
      }
      
      cell.classList.add('week-start');
      
      const clickDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
      cell.onclick = () => addWeekFromDate(clickDate);
      
      row.appendChild(cell);
    }
    
    calendarBody.appendChild(row);
  }
}

function previousMonth() {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
  renderCalendar();
}

function nextMonth() {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
  renderCalendar();
}

// ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
function addCategory(categoryName = null) {
  const tableBody = document.getElementById('tableBody');
  const tr = document.createElement('tr');
  
  const categoryTd = document.createElement('td');
  categoryTd.className = 'category-cell category-column';
  
  if (categoryName) {
    categoryTd.innerHTML = `
      <select onchange="updateCategoryName(this); handleInputChange(this)">
        <option value="Webåºƒå‘ŠãƒãƒŠãƒ¼" ${categoryName === 'Webåºƒå‘ŠãƒãƒŠãƒ¼' ? 'selected' : ''}>Webåºƒå‘ŠãƒãƒŠãƒ¼</option>
        <option value="åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ" ${categoryName === 'åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ' ? 'selected' : ''}>åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ</option>
        <option value="ãƒ‡ã‚¶ã‚¤ãƒ³" ${categoryName === 'ãƒ‡ã‚¶ã‚¤ãƒ³' ? 'selected' : ''}>ãƒ‡ã‚¶ã‚¤ãƒ³</option>
        <option value="ãã®ä»–" ${!['Webåºƒå‘ŠãƒãƒŠãƒ¼', 'åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ', 'ãƒ‡ã‚¶ã‚¤ãƒ³'].includes(categoryName) ? 'selected' : ''}>ãã®ä»–</option>
      </select>
      <br>ç·æ•°: <input type="number" value="0" oninput="handleInputChange(this)">
      <button class="delete-category-btn" onclick="deleteCategory(this)">å‰Šé™¤</button>
    `;
  } else {
    categoryTd.innerHTML = `
      <select onchange="updateCategoryName(this); handleInputChange(this)">
        <option value="Webåºƒå‘ŠãƒãƒŠãƒ¼">Webåºƒå‘ŠãƒãƒŠãƒ¼</option>
        <option value="åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ">åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ</option>
        <option value="ãƒ‡ã‚¶ã‚¤ãƒ³">ãƒ‡ã‚¶ã‚¤ãƒ³</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
      <br>ç·æ•°: <input type="number" value="0" oninput="handleInputChange(this)">
      <button class="delete-category-btn" onclick="deleteCategory(this)">å‰Šé™¤</button>
    `;
  }
  
  tr.appendChild(categoryTd);
  
  weeks.forEach(week => {
    const td = document.createElement('td');
    td.dataset.week = week;
    td.className = 'week-column';
    
    if (hiddenWeeks.has(week)) {
      td.classList.add('week-column-hidden');
    }
    
    // createImageArea()ã‚’ä½¿ç”¨ã—ã¦ã€ç¢ºå®Ÿã«ã‚¤ãƒ™ãƒ³ãƒˆãŒè¨­å®šã•ã‚ŒãŸç”»åƒã‚¨ãƒªã‚¢ã‚’ä½œæˆ
    const imgArea = createImageArea();
    td.appendChild(imgArea);
    
    td.innerHTML += `
      <br>URL: <input type="text" placeholder="BOX URL" oninput="handleInputChange(this)">
      <br>ã‚«ãƒ†ã‚´ãƒª: <select onchange="handleInputChange(this)">
        <option>ãƒ‡ã‚¶ã‚¤ãƒ³</option>
        <option>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</option>
        <option>å ´é¢å†™</option>
      </select>
      <br>æ•°é‡: <input type="number" placeholder="0" oninput="handleInputChange(this)">
    `;
    
    tr.appendChild(td);
  });
  
  tableBody.appendChild(tr);
  calculateTableWidth();
  
  // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
  syncDataToFirebase();
}

function deleteCategory(button) {
  if (!confirm('ã“ã®ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    return;
  }
  
  const row = button.closest('tr');
  row.remove();
  calculateTableWidth();
  
  // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
  syncDataToFirebase();
}

function updateHiddenWeekSelect() {
  const select = document.getElementById('hiddenWeekSelect');
  select.innerHTML = '<option value="">éè¡¨ç¤ºã®é€±ã‚’é¸æŠ</option>';
  
  hiddenWeeks.forEach(week => {
    const option = document.createElement('option');
    option.value = week;
    option.textContent = week;
    select.appendChild(option);
  });
}

function updateCategoryName(select) {
  console.log('ã‚«ãƒ†ã‚´ãƒªãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', select.value);
}

function toggleWeekVisibility(week) {
  const isHidden = hiddenWeeks.has(week);
  
  const headerRow = document.getElementById('headerRow');
  const targetHeader = headerRow.querySelector(`th[data-week="${week}"]`);
  const toggleButton = targetHeader.querySelector('.toggle-btn');
  
  const tableBody = document.getElementById('tableBody');
  const targetCells = tableBody.querySelectorAll(`td[data-week="${week}"]`);
  
  if (isHidden) {
    hiddenWeeks.delete(week);
    targetHeader.classList.remove('week-column-hidden');
    toggleButton.classList.remove('hidden');
    toggleButton.textContent = 'éè¡¨ç¤º';
    
    targetCells.forEach(cell => {
      cell.classList.remove('week-column-hidden');
    });
  } else {
    hiddenWeeks.add(week);
    targetHeader.classList.add('week-column-hidden');
    toggleButton.classList.add('hidden');
    toggleButton.textContent = 'è¡¨ç¤º';
    
    targetCells.forEach(cell => {
      cell.classList.add('week-column-hidden');
    });
  }
  
  updateHiddenWeekSelect();
  calculateTableWidth();
  
  // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
  syncDataToFirebase();
}

function showHiddenWeek() {
  const select = document.getElementById('hiddenWeekSelect');
  const weekToShow = select.value;
  
  if (!weekToShow) {
    alert('è¡¨ç¤ºã™ã‚‹é€±ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  toggleWeekVisibility(weekToShow);
}

function showAllWeeks() {
  if (hiddenWeeks.size === 0) {
    alert('éè¡¨ç¤ºã®é€±ã¯ã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  const hiddenWeeksList = Array.from(hiddenWeeks);
  hiddenWeeksList.forEach(week => {
    toggleWeekVisibility(week);
  });
  
  alert('å…¨ã¦ã®é€±ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
}

// ========== ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ©Ÿèƒ½ ==========

// ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿
function saveLocalSettings() {
  const settings = {
    weeks,
    categories,
    hiddenWeeks: Array.from(hiddenWeeks),
    currentZoom
  };
  localStorage.setItem('scheduleToolSettings', JSON.stringify(settings));
}

function loadLocalSettings() {
  const settingsStr = localStorage.getItem('scheduleToolSettings');
  if (settingsStr) {
    const settings = JSON.parse(settingsStr);
    weeks = settings.weeks || ["7/1"];
    categories = settings.categories || ["Webåºƒå‘ŠãƒãƒŠãƒ¼", "åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ", "ãƒ‡ã‚¶ã‚¤ãƒ³"];
    hiddenWeeks = new Set(settings.hiddenWeeks || []);
    currentZoom = settings.currentZoom || 100;
  }
}

// ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
function getCurrentData() {
  const data = {
    timestamp: new Date().toISOString(),
    weeks: weeks,
    categories: categories,
    hiddenWeeks: Array.from(hiddenWeeks),
    currentZoom: currentZoom,
    tableData: []
  };
  
  // å„è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const rows = document.querySelectorAll('#tableBody tr');
  rows.forEach((row, rowIndex) => {
    const rowData = {
      category: '',
      totalCount: 0,
      weekData: {}
    };
    
    // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±
    const categoryCell = row.querySelector('.category-cell');
    if (categoryCell) {
      const categorySelect = categoryCell.querySelector('select');
      const totalInput = categoryCell.querySelector('input[type="number"]');
      rowData.category = categorySelect ? categorySelect.value : '';
      rowData.totalCount = totalInput ? parseInt(totalInput.value) || 0 : 0;
    }
    
    // å„é€±ã®ãƒ‡ãƒ¼ã‚¿
    weeks.forEach(week => {
      const weekCell = row.querySelector(`td[data-week="${week}"]`);
      if (weekCell) {
        const urlInput = weekCell.querySelector('input[type="text"]');
        const categorySelect = weekCell.querySelector('select');
        const countInput = weekCell.querySelector('input[type="number"]');
        const imgArea = weekCell.querySelector('.img-area');
        
        rowData.weekData[week] = {
          url: urlInput ? urlInput.value : '',
          category: categorySelect ? categorySelect.value : '',
          count: countInput ? parseInt(countInput.value) || 0 : 0,
          imageData: null
        };
        
        // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        if (imgArea && imgArea.classList.contains('has-image')) {
          const img = imgArea.querySelector('img');
          if (img) {
            rowData.weekData[week].imageData = img.src;
          }
        }
      }
    });
    
    data.tableData.push(rowData);
  });
  
  return data;
}

// ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
function restoreData(data) {
  // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
  clearTable();
  
  // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
  weeks = data.weeks || ["7/1"];
  categories = data.categories || ["Webåºƒå‘ŠãƒãƒŠãƒ¼", "åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ", "ãƒ‡ã‚¶ã‚¤ãƒ³"];
  hiddenWeeks = new Set(data.hiddenWeeks || []);
  currentZoom = data.currentZoom || 100;
  
  // ã‚ºãƒ¼ãƒ ã‚’å¾©å…ƒ
  document.getElementById('zoomSlider').value = currentZoom;
  updateZoom(currentZoom);
  
  // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æ§‹ç¯‰
  rebuildTable(data.tableData || []);
  
  // ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã‚‚æ›´æ–°
  saveLocalSettings();
  
  console.log('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
  fixExistingImageAreas(); // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾©å…ƒ
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢
function clearTable() {
  const headerRow = document.getElementById('headerRow');
  const tableBody = document.getElementById('tableBody');
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ—ä»¥å¤–ï¼‰
  const headers = headerRow.querySelectorAll('th:not(.category-column)');
  headers.forEach(header => header.remove());
  
  // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã‚’ã‚¯ãƒªã‚¢
  tableBody.innerHTML = '';
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æ§‹ç¯‰
function rebuildTable(tableData) {
  const headerRow = document.getElementById('headerRow');
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å†æ§‹ç¯‰
  weeks.forEach(week => {
    const th = document.createElement('th');
    th.dataset.week = week;
    th.className = 'week-column';
    
    if (hiddenWeeks.has(week)) {
      th.classList.add('week-column-hidden');
    }
    
    th.innerHTML = `
      <div class="week-header">
        <span>${week}</span>
        <button class="toggle-btn ${hiddenWeeks.has(week) ? 'hidden' : ''}" 
                onclick="toggleWeekVisibility('${week}')">
          ${hiddenWeeks.has(week) ? 'è¡¨ç¤º' : 'éè¡¨ç¤º'}
        </button>
      </div>
      <div class="resize-handle"></div>
    `;
    
    headerRow.appendChild(th);
  });
  
  // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
  tableData.forEach(rowData => {
    const tr = document.createElement('tr');
    
    // ã‚«ãƒ†ã‚´ãƒªã‚»ãƒ«
    const categoryTd = document.createElement('td');
    categoryTd.className = 'category-cell category-column';
    categoryTd.innerHTML = `
      <select onchange="updateCategoryName(this); handleInputChange(this)">
        <option value="Webåºƒå‘ŠãƒãƒŠãƒ¼" ${rowData.category === 'Webåºƒå‘ŠãƒãƒŠãƒ¼' ? 'selected' : ''}>Webåºƒå‘ŠãƒãƒŠãƒ¼</option>
        <option value="åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ" ${rowData.category === 'åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ' ? 'selected' : ''}>åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ</option>
        <option value="ãƒ‡ã‚¶ã‚¤ãƒ³" ${rowData.category === 'ãƒ‡ã‚¶ã‚¤ãƒ³' ? 'selected' : ''}>ãƒ‡ã‚¶ã‚¤ãƒ³</option>
        <option value="ãã®ä»–" ${rowData.category === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
      </select>
      <br>ç·æ•°: <input type="number" value="${rowData.totalCount}" oninput="handleInputChange(this)">
      <button class="delete-category-btn" onclick="deleteCategory(this)">å‰Šé™¤</button>
    `;
    tr.appendChild(categoryTd);
    
    // å„é€±ã®ã‚»ãƒ«
    weeks.forEach(week => {
      const td = document.createElement('td');
      td.dataset.week = week;
      td.className = 'week-column';
      
      if (hiddenWeeks.has(week)) {
        td.classList.add('week-column-hidden');
      }
      
      const weekData = rowData.weekData[week] || {};
      
      // ç”»åƒã‚¨ãƒªã‚¢ã‚’ä½œæˆ
      const imgArea = createImageArea();
      if (weekData.imageData) {
        console.log('ä¿å­˜ã•ã‚ŒãŸç”»åƒã‚’å¾©å…ƒä¸­');
        // ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å¾©å…ƒ
        imgArea.innerHTML = '';
        
        const img = document.createElement('img');
        img.src = weekData.imageData;
        img.alt = 'ç”»åƒ';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '2px';
        imgArea.appendChild(img);
        
        // input ã¨ deleteBtn ã‚’å†è¿½åŠ ï¼ˆcreateImageAreaã§ä½œæˆæ¸ˆã¿ã®ã‚‚ã®ã‚’ä½¿ç”¨ï¼‰
        const input = imgArea.querySelector('input[type="file"]') || imgArea.children[imgArea.children.length - 2];
        const deleteBtn = imgArea.querySelector('.img-delete') || imgArea.children[imgArea.children.length - 1];
        
        if (input && deleteBtn) {
          imgArea.appendChild(input);
          imgArea.appendChild(deleteBtn);
          deleteBtn.style.display = 'block';
          imgArea.classList.add('has-image');
        }
      }
      
      td.appendChild(imgArea);
      
      td.innerHTML += `
        <br>URL: <input type="text" placeholder="BOX URL" value="${weekData.url || ''}" oninput="handleInputChange(this)">
        <br>ã‚«ãƒ†ã‚´ãƒª: <select onchange="handleInputChange(this)">
          <option ${weekData.category === 'ãƒ‡ã‚¶ã‚¤ãƒ³' ? 'selected' : ''}>ãƒ‡ã‚¶ã‚¤ãƒ³</option>
          <option ${weekData.category === 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' ? 'selected' : ''}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</option>
          <option ${weekData.category === 'å ´é¢å†™' ? 'selected' : ''}>å ´é¢å†™</option>
        </select>
        <br>æ•°é‡: <input type="number" placeholder="0" value="${weekData.count || ''}" oninput="handleInputChange(this)">
      `;
      
      tr.appendChild(td);
    });
    
    document.getElementById('tableBody').appendChild(tr);
  });
  
  updateHiddenWeekSelect();
  calculateTableWidth();
}

// åˆæœŸåŒ–å®Ÿè¡Œ
window.addEventListener('load', init);

// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã‚’ä¿å­˜
window.addEventListener('beforeunload', () => {
  saveLocalSettings();
  
  // ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹å‰Šé™¤
  if (firestore && currentProjectId && currentUser) {
    firestore.collection('projects').doc(currentProjectId).collection('users').doc(currentUser).delete();
  }
  
  // ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ›´æ–°ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
  if (presenceUpdateInterval) {
    clearInterval(presenceUpdateInterval);
  }
});


function deleteWeek(week) {
  if (!confirm(`é€±ã€Œ${week}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  weeks = weeks.filter(w => w !== week);
  hiddenWeeks.delete(week);

  const header = document.querySelector(`th[data-week='${week}']`);
  if (header) header.remove();

  const cells = document.querySelectorAll(`td[data-week='${week}']`);
  cells.forEach(cell => cell.remove());

  updateHiddenWeekSelect();
  calculateTableWidth();
  syncDataToFirebase();
}

function deleteSelectedWeek() {
  const select = document.getElementById('hiddenWeekSelect');
  const week = select.value;
  if (!week) {
    alert('å‰Šé™¤ã™ã‚‹é€±ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  deleteWeek(week);
}
</script>
<script>
document.addEventListener('paste', function (e) {
  const items = (e.clipboardData || e.originalEvent.clipboardData).items;
  for (const item of items) {
    if (item.type.indexOf('image') !== -1) {
      const blob = item.getAsFile();
      const reader = new FileReader();
      reader.onload = function (event) {
        const focusedArea = document.querySelector('.img-area:hover');
        if (!focusedArea) return;

        focusedArea.innerHTML = '';
        const img = document.createElement('img');
        img.src = event.target.result;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '2px';
        focusedArea.appendChild(img);

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.style.display = 'none';
        focusedArea.appendChild(input);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'img-delete';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block';
        focusedArea.appendChild(deleteBtn);

        focusedArea.classList.add('has-image');

        deleteBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          if (confirm('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            focusedArea.innerHTML = '<span style="font-size:12px;color:#888;">ğŸ“· ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯</span>';
            focusedArea.classList.remove('has-image');
          }
        });

        if (typeof syncDataToFirebase === 'function' && isConnected && firestore) {
          setTimeout(syncDataToFirebase, 1000);
        }
      };
      reader.readAsDataURL(blob);
      break;
    }
  }
});
</script></body>
</html>
